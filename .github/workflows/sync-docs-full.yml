name: Full Docs Sync to Vector Store

on:
  push:  # Allow manual triggering only

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get all MDX files and prepare payload
        id: files
        run: |
          # Find all MDX files in content directory and store in a file
          echo "Finding all MDX files..."
          find content -name "*.mdx" | sed 's|^content/||' > mdx_files.txt
          echo "Found files:"
          cat mdx_files.txt
          
          # Build JSON payload with all files
          payload=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --slurpfile files <(cat mdx_files.txt | jq -R .) \
            --slurpfile changed <(
              while IFS= read -r f; do
                if [ -f "content/$f" ]; then
                  echo "Processing file: content/$f"
                  jq -n \
                    --arg path "$f" \
                    --arg content "$(base64 -w0 < "content/$f")" \
                    '{path: $path, content: $content}'
                fi
              done < mdx_files.txt | jq -s '.'
            ) \
            '{
              repo: $repo,
              removed: $files,
              changed: ($changed | .[0] // [])
            }'
          )
          
          # Save payload to file to avoid GitHub Actions output issues
          echo "$payload" > payload.json
          
          # Set the payload path as output
          echo "payload_path=payload.json" >> $GITHUB_OUTPUT

      - name: Show debug info
        run: |
          echo "Files to process:"
          jq -r '.changed[].path' payload.json
          echo -e "\nFiles to remove first:"
          jq -r '.removed[]' payload.json
          echo -e "\nFull payload:"
          cat payload.json
        #   curl https://agentuity.ai/webhook/f61d5ce9d6ed85695cc992c55ccdc2a6 \
        #     -X POST \
        #     -H "Content-Type: application/json" \
        #     -d @payload.json 