name: Full Docs Sync to Vector Store

on:
    push:
        
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get all MDX files and prepare payload
        id: files
        run: |
          # Find all MDX files in content directory
          echo "Finding all MDX files..."
          ALL_FILES=$(find content -name "*.mdx" | sed 's|^content/||')
          echo "Found files:"
          echo "$ALL_FILES"
          
          # Build JSON payload with all files
          payload=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --argjson removed "$(
              printf '%s\n' $ALL_FILES | jq -R -s -c 'split("\n") | map(select(length > 0))'
            )" \
            --argjson changed "$(
              for f in $ALL_FILES; do
                if [ -f "content/$f" ]; then
                  echo "Processing file: content/$f"
                  jq -n \
                    --arg path "$f" \
                    --arg content "$(base64 -w0 < "content/$f")" \
                    '{path: $path, content: $content}'
                fi
              done | jq -s '.'
            )" \
            '{repo: $repo, changed: $changed, removed: $removed}'
          )
          
          echo "payload<<EOF" >> $GITHUB_OUTPUT
          echo "$payload" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Trigger Agentuity Sync Agent
        run: |
          echo "Sending payload to agent. Files to process:"
          echo '${{ steps.files.outputs.payload }}' | jq -r '.changed[].path'
          echo "Files to remove first:"
          echo '${{ steps.files.outputs.payload }}' | jq -r '.removed[]'
          echo "Test payload:"
          echo '${{ steps.files.outputs.payload }}'
        #   curl https://agentuity.ai/webhook/f61d5ce9d6ed85695cc992c55ccdc2a6 \
        #     -X POST \
        #     -H "Content-Type: application/json" \
        #     -d '${{ steps.files.outputs.payload }}' 