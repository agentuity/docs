name: Full Docs Sync to Vector Store

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get all MDX files and prepare payload
        id: files
        run: |
          # First find all MDX files recursively
          echo "Finding all MDX files..."
          find content -type f -name "*.mdx" | sed 's|^content/||' > mdx_files.txt
          echo "Found files:"
          cat mdx_files.txt
          
          # Create JSON array of changed files
          echo "Processing files..."
          changed_files="[]"
          while IFS= read -r path; do
            [ -z "$path" ] && continue
            if [ -f "content/$path" ]; then
              echo "Processing: content/$path" >&2
              file_json=$(jq -n \
                --arg path "$path" \
                --arg content "$(base64 -w0 < "content/$path")" \
                '{path: $path, content: $content}')
              changed_files=$(echo "$changed_files" | jq --argjson file "$file_json" '. + [$file]')
            fi
          done < mdx_files.txt
          
          # Create removed files array (same as changed for full sync)
          removed_files=$(cat mdx_files.txt | jq -R . | jq -s .)
          
          # Create final payload
          jq -n \
            --argjson changed "$changed_files" \
            --argjson removed "$removed_files" \
            --arg repo "$GITHUB_REPOSITORY" \
            '{
              repo: $repo,
              changed: $changed,
              removed: $removed
            }' > payload.json
          
          # Show debug info
          echo "Payload structure (without contents):"
          jq 'del(.changed[].content)' payload.json

      - name: Send to Agentuity
        run: |
          echo "About to sync these files:"
          jq -r '.changed[].path' payload.json
          echo -e "\nWill first remove these paths:"
          jq -r '.removed[]' payload.json
          
          # Uncomment to actually send
          curl https://agentuity.ai/webhook/f61d5ce9d6ed85695cc992c55ccdc2a6 \
            -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json 