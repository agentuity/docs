name: Sync Docs to Vector Store

on:
  push:
    branches:
      - main
    paths:
      - 'content/**'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Get changed and removed files
        id: files
        run: |
          git fetch origin ${{ github.event.before }}
          echo "changed=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- 'content/**/*.mdx' | xargs)" >> $GITHUB_OUTPUT
          echo "removed=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.sha }} -- 'content/**/*.mdx' | xargs)" >> $GITHUB_OUTPUT

      - name: Trigger Agentuity Sync Agent
        env:
          AGENTUITY_TOKEN: ${{ secrets.AGENTUITY_TOKEN }}
        run: |
          # Convert space-separated lists to JSON arrays
          changed_json=$(jq -n --arg files "${{ steps.files.outputs.changed }}" '$files | split(" ") | map(select(length > 0))')
          removed_json=$(jq -n --arg files "${{ steps.files.outputs.removed }}" '$files | split(" ") | map(select(length > 0))')
          # POST to Agentuity agent webhook
          curl https://agentuity.ai/webhook/f61d5ce9d6ed85695cc992c55ccdc2a6 \
            -X POST \
            -H "Authorization: Bearer $AGENTUITY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"changedFiles":'$changed_json', "removedFiles":'$removed_json'}'