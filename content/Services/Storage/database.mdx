---
title: Database
description: Relational database storage using Bun's native SQL APIs
---

Store structured data with queries, joins, and transactions using [Bun's native SQL APIs](https://bun.com/docs/runtime/sql).

## When to Use Database Storage

| Storage Type | Best For |
|--------------|----------|
| **Database** | Structured data, complex queries, transactions, relational data |
| [Key-Value](/Services/Storage/key-value) | Fast lookups, caching, configuration |
| [Vector](/Services/Storage/vector) | Semantic search, embeddings, RAG |
| [Object (S3)](/Services/Storage/object) | Files, images, documents, media |
| [Durable Streams](/Services/Storage/durable-streams) | Large exports, audit logs |

<Callout type="info" title="Credentials Auto-Injected">
When you create a database with `agentuity cloud db create`, the `DATABASE_URL` is automatically added to your `.env` file. During deployment, credentials are injected automatically.
</Callout>

## Creating a Database

```bash
# Create with default settings
agentuity cloud db create

# Create with name and description
agentuity cloud db create --name "users-db" --description "Primary user data store"
```

## Quick Start

```typescript
import { sql } from "bun";

// Query with automatic SQL injection protection
const users = await sql`SELECT * FROM users WHERE active = ${true}`;

// Insert data
await sql`INSERT INTO users (name, email) VALUES (${"Alice"}, ${"alice@example.com"})`;

// Update data
await sql`UPDATE users SET active = ${false} WHERE id = ${userId}`;

// Delete data
await sql`DELETE FROM users WHERE id = ${userId}`;
```

<Callout type="warn" title="SQL Injection Prevention">
Always use template literal parameters (`${value}`) for dynamic values. Never concatenate strings into queries.
</Callout>

## Using in Agents

```typescript
import { createAgent } from '@agentuity/runtime';
import { sql } from "bun";

const agent = createAgent('UserQuery', {
  handler: async (ctx, input) => {
    const users = await sql`
      SELECT * FROM users
      WHERE active = ${true}
      AND created_at > ${input.since}
      ORDER BY created_at DESC
      LIMIT 10
    `;

    ctx.logger.info("Query results", { count: users.length });
    return { users };
  },
});
```

## Using in Routes

```typescript
import { createRouter } from '@agentuity/runtime';
import { sql } from "bun";

const router = createRouter();

router.get('/users', async (c) => {
  const limit = parseInt(c.req.query('limit') || '10');
  const users = await sql`
    SELECT id, name, email FROM users
    ORDER BY created_at DESC
    LIMIT ${limit}
  `;
  return c.json({ users });
});

router.post('/users', async (c) => {
  const body = await c.req.json();
  const result = await sql`
    INSERT INTO users (name, email)
    VALUES (${body.name}, ${body.email})
    RETURNING id, name, email
  `;
  return c.json({ user: result[0] }, 201);
});

export default router;
```

## Transactions

Use transactions for operations that must succeed or fail together:

```typescript
import { sql } from "bun";

await sql.begin(async (tx) => {
  await tx`UPDATE accounts SET balance = balance - ${amount} WHERE id = ${fromAccount}`;
  await tx`UPDATE accounts SET balance = balance + ${amount} WHERE id = ${toAccount}`;
  await tx`INSERT INTO transfers (from_id, to_id, amount) VALUES (${fromAccount}, ${toAccount}, ${amount})`;
});
```

## Supported Databases

Bun's SQL API supports PostgreSQL, MySQL, and SQLite:

```typescript
import { SQL } from "bun";

// PostgreSQL (default, uses DATABASE_URL)
const users = await sql`SELECT * FROM users`;

// Custom PostgreSQL connection
const postgres = new SQL("postgres://user:pass@localhost:5432/mydb");

// MySQL
const mysql = new SQL("mysql://user:pass@localhost:3306/mydb");

// SQLite
const sqlite = new SQL("sqlite://data/app.db");
```

For complete Bun SQL documentation, see the [Bun SQL docs](https://bun.com/docs/runtime/sql).

## Resilient Postgres Client

The `@agentuity/postgres` package provides a PostgreSQL client built for serverless environments with automatic reconnection.

```bash
bun add @agentuity/postgres
```

```typescript
import { postgres } from '@agentuity/postgres';

// Create client (uses DATABASE_URL by default)
const sql = postgres();

// Queries automatically retry on connection errors
const users = await sql`SELECT * FROM users WHERE active = ${true}`;

// Transactions
await sql.begin(async (tx) => {
  await tx`UPDATE accounts SET balance = balance - ${100} WHERE name = ${'Alice'}`;
  await tx`UPDATE accounts SET balance = balance + ${100} WHERE name = ${'Bob'}`;
});
```

### Configuration

```typescript
const sql = postgres({
  url: 'postgres://user:pass@localhost:5432/mydb',
  reconnect: {
    maxAttempts: 10,
    initialDelayMs: 100,
    maxDelayMs: 30000,
  },
  onclose: (error) => console.log('Connection closed', error),
  onreconnected: () => console.log('Reconnected!'),
});
```

**Key features:**
- Automatic reconnection with exponential backoff
- Query retry on retryable errors
- Graceful shutdown on SIGTERM/SIGINT
- Connection stats via `sql.stats`

## Drizzle ORM

The `@agentuity/drizzle` package provides type-safe database access with [Drizzle ORM](https://orm.drizzle.team/).

```bash
bun add @agentuity/drizzle drizzle-orm
```

```typescript
import { createPostgresDrizzle, eq } from '@agentuity/drizzle';
import * as schema from './schema';

const { db, close } = createPostgresDrizzle({ schema });

// Type-safe queries
const activeUsers = await db
  .select()
  .from(schema.users)
  .where(eq(schema.users.active, true));

// Insert with returning
const [newUser] = await db
  .insert(schema.users)
  .values({ name: 'Alice', email: 'alice@example.com' })
  .returning();
```

### Defining Your Schema

```typescript
// schema.ts
import { pgTable, serial, text, boolean, timestamp } from 'drizzle-orm/pg-core';

export const users = pgTable('users', {
  id: serial('id').primaryKey(),
  name: text('name').notNull(),
  email: text('email').notNull().unique(),
  active: boolean('active').default(true),
  createdAt: timestamp('created_at').defaultNow(),
});
```

### Configuration

```typescript
const { db, client, close } = createPostgresDrizzle({
  schema,
  url: 'postgres://user:pass@localhost:5432/mydb',
  logger: true,
  reconnect: { maxAttempts: 5 },
  onReconnected: () => console.log('Reconnected'),
});
```

### Migrations

Use `drizzle-kit` to manage schema migrations:

```bash
bun add -D drizzle-kit
bunx drizzle-kit generate
bunx drizzle-kit migrate
```

See the [Drizzle documentation](https://orm.drizzle.team/docs/migrations) for migration configuration.

### Auth Integration

Use with `@agentuity/auth` for user management:

```typescript
import { createPostgresDrizzle, drizzleAdapter } from '@agentuity/drizzle';
import * as schema from './schema';

const { db } = createPostgresDrizzle({ schema });
const authAdapter = drizzleAdapter(db);
```

See [Authentication](/Frontend/authentication) for full setup.

## Next Steps

- [Key-Value Storage](/Services/Storage/key-value): Fast caching and session data
- [Vector Storage](/Services/Storage/vector): Semantic search and embeddings
- [Object Storage (S3)](/Services/Storage/object): File and media storage
