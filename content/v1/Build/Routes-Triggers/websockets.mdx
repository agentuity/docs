---
title: WebSockets
description: Real-time bidirectional communication with router.websocket()
---

WebSockets enable persistent, bidirectional connections between client and server. Use them for chat interfaces, live dashboards, collaborative tools, and any scenario requiring real-time two-way communication.

## Basic Example

```typescript
import { createRouter } from '@agentuity/runtime';

const router = createRouter();

router.websocket('/chat', (c) => (ws) => {
  ws.onOpen(() => {
    c.var.logger.info('Client connected');
    ws.send('Connected!');
  });

  ws.onMessage(async (event) => {
    const message = event.data as string;
    const response = await c.agent.chatAgent.run({ message });
    ws.send(response);
  });

  ws.onClose(() => {
    c.var.logger.info('Client disconnected');
  });
});

export default router;
```

## Handler Structure

The WebSocket handler uses a callback pattern:

```typescript
router.websocket('/path', (c) => (ws) => {
  // c - Hono context (available in closure)
  // ws - WebSocket connection object

  ws.onOpen(() => { /* connection opened */ });
  ws.onMessage(async (event) => { /* message received */ });
  ws.onClose(() => { /* connection closed */ });
});
```

## WebSocket Events

| Event | Trigger | Example Use Case |
|-------|---------|------------------|
| `onOpen` | Connection established | Send welcome message, initialize state |
| `onMessage` | Client sends data | Process messages, call agents |
| `onClose` | Connection ends | Clean up resources |

## Server Push

Send data to the client without waiting for a request:

```typescript
router.websocket('/notifications', (c) => (ws) => {
  let heartbeat: Timer;

  ws.onOpen(() => {
    ws.send(JSON.stringify({ type: 'connected' }));

    // Push updates every 5 seconds
    heartbeat = setInterval(() => {
      ws.send(JSON.stringify({
        type: 'heartbeat',
        time: new Date().toISOString(),
      }));
    }, 5000);
  });

  ws.onClose(() => {
    clearInterval(heartbeat); // Clean up!
  });
});
```

## Full Example

A real-time echo server with heartbeat:

```typescript
import { createRouter } from '@agentuity/runtime';

const router = createRouter();

router.websocket('/', (c) => (ws) => {
  let heartbeat: Timer;

  ws.onOpen(() => {
    c.var.logger.info('WebSocket connected');
    ws.send('Connected! Send a message to echo it back.');

    heartbeat = setInterval(() => {
      ws.send(`Ping: ${new Date().toLocaleTimeString()}`);
    }, 5000);
  });

  ws.onMessage(async (event) => {
    try {
      const message = event.data as string;
      c.var.logger.info('Message received', { message });

      const response = await c.agent.echoAgent.run(message);
      ws.send(response);
    } catch (error) {
      c.var.logger.error('Message processing failed', { error });
      ws.send(JSON.stringify({ error: 'Processing failed' }));
    }
  });

  ws.onClose(() => {
    c.var.logger.info('WebSocket disconnected');
    clearInterval(heartbeat);
  });
});

export default router;
```

## Resource Cleanup

Always clean up intervals, subscriptions, or other resources in `onClose`:

```typescript
ws.onClose(() => {
  clearInterval(heartbeat);  // Prevent memory leaks
  subscription.unsubscribe();
});
```

Failing to clean up can cause memory leaks and unexpected behavior.

## Client Connection

Connect from a browser or any WebSocket client:

```javascript
const ws = new WebSocket('wss://your-project.agentuity.cloud/agent-name');

ws.onopen = () => {
  console.log('Connected');
  ws.send('Hello!');
};

ws.onmessage = (event) => {
  console.log('Received:', event.data);
};

ws.onclose = () => {
  console.log('Disconnected');
};
```

## When to Use WebSockets

| Use Case | WebSocket | SSE | HTTP |
|----------|-----------|-----|------|
| Chat / messaging | ✓ | | |
| Live collaboration | ✓ | | |
| Real-time dashboards | ✓ | ✓ | |
| Progress updates | | ✓ | |
| Request/response API | | | ✓ |

Use WebSockets when you need **bidirectional** communication. For **server-to-client only** streaming, consider [Server-Sent Events](/Build/Routes-Triggers/sse).

## Next Steps

- [Server-Sent Events](/Build/Routes-Triggers/sse): One-way streaming from server to client
- [HTTP Routes](/Build/Routes-Triggers/http-routes): Standard request/response endpoints
- [React Hooks](/Build/Frontend/react-hooks): Connect from React with `useAgentWebsocket`
